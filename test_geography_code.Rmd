---
title: "Playing with some R packages to look at geography"
author: "Janet Young"
date: "`r Sys.Date()`"
output: github_document
always_allow_html: true
---

# Try `tidycensus` package

```{r setup, include=FALSE}
library(tidycensus)
library(tidyverse)
library(viridis)
library(kableExtra)
library(sf)

# each user should obtain a Census API key from http://api.census.gov/data/key_signup.html
# save it in a file called censusAPIkey.txt (this will NOT be synced to github)
myKey <- scan("censusAPIkey.txt", what="character", quiet=TRUE)
census_api_key(myKey)
```

This package is designed to query census data. Population counts, and registered voter counts could be useful for Whole WA questions, but more usefully I think we can use it to look up boundaries for zip codes and LDs. Maybe there are more direct ways to get the map data? (xxx to do:  research `tigris` package)

It's tempting to look at other census data too (e.g. age, income) but we should probably stay focussed (for now!).  

Available geographic levels are listed [here](https://walker-data.com/tidycensus/articles/basic-usage.html) and include:  
    + "state"  
    + "county"  
    + "zip code tabulation area"  
    + "state legislative district (upper chamber)"  
    + "state legislative district (lower chamber)"  
    + "voting district"  

## Tutorials, notes

Tidycensus functions are listed [here](https://walker-data.com/tidycensus/reference/index.html)

Basic usage is described [here](https://walker-data.com/tidycensus/articles/basic-usage.html)

Usage for spatial data is described [here](https://walker-data.com/tidycensus/articles/spatial-data.html)

Tidycensus has two major functions:  
    + `get_decennial()`, which grants access to the 2000, 2010, and 2020 decennial US Census APIs  
    + `get_acs()`, which grants access to the 1-year and 5-year American Community Survey APIs  
    
If we include `geometry = TRUE` in a tidycensus function call, tidycensus retrieves geographic data from the US Census Bureau  (using the `tigris` package). Spatial data gets merged with the tabular data we requested, in the `geometry` column.

We can use `ggplot + geom_sf` to plot the data as maps


## What data is available to us?

Each census dataset has thousands of variables. 

Here, I get the variable codes for a couple of datasets:
```{r getting codes}
acs5_2017_vars <- load_variables(2017, "acs5", cache = TRUE)
sf1_2010_vars <- load_variables(2010, "sf1", cache = TRUE)
```

And show three random rows of each resulting table:
```{r show a bit of the acs5_2017_vars table}
acs5_2017_vars %>% 
    slice_sample(n=3) %>% 
    kable(caption="Example variables from 2017 acs5 dataset") %>% 
    kable_styling(font_size = 9)
```


```{r show a bit of the sf1_2010_vars table}
sf1_2010_vars %>% 
    slice_sample(n=3) %>% 
    kable(caption="Example variables from 2010 sf1 dataset") %>% 
    kable_styling(font_size = 9)
```


## Example 1: median age by state

Get the data:
```{r get median age by state, message = FALSE, warning=FALSE, echo=TRUE}
## age10 is a tibble, 52 rows (each state), 4 columns
age10 <- get_decennial(geography = "state", 
                                variables = "P013001", 
                                year = 2010) 
```
Plot it:
```{r plot median age by state}
age10 %>%
    ggplot(aes(x = value, y = reorder(NAME, value))) + 
    geom_point() +
    labs(x="Median age", y="", title = "Median age by state")
```


## Example 2 - spatial data

This example gets household income by tract in Tarrant county, Texas and plots it spatially:

```{r tract mapping example - get data, message = FALSE, warning=FALSE, echo=TRUE}
tarr <- get_acs(geography = "tract", variables = "B19013_001",
                state = "TX", county = "Tarrant", geometry = TRUE, year = 2020)

ggplot(tarr, aes(fill = estimate, color = estimate)) +
    geom_sf() +
    coord_sf(crs = 26914) +
    scale_fill_viridis(option = "magma") +
    scale_color_viridis(option = "magma") +
    labs(title="Household income by tract in Tarrant county, Texas")
```

This gets data by county (household income in Vermont)

```{r county mapping example - get data, message = FALSE, warning=FALSE, echo=TRUE}
vt <- get_acs(geography = "county", variables = "B19013_001", state = "VT", year = 2019)

vt %>%
    mutate(NAME = gsub(" County, Vermont", "", NAME)) %>%
    ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
    geom_errorbar(aes(xmin = estimate - moe, xmax = estimate + moe), width = 0.3, size = 0.5) +
    geom_point(color = "red", size = 3) +
    labs(title = "Household income by county in Vermont",
         subtitle = "2015-2019 American Community Survey",
         y = "",
         x = "ACS estimate (bars represent margin of error)")
```

More on the spatial data, from [here](https://walker-data.com/tidycensus/articles/spatial-data.html):
"Our object `tarr` looks much like the basic tidycensus output, but with a geometry list-column describing the geometry of each feature, using the geographic coordinate system NAD 1983 (EPSG: 4269) which is the default for Census shapefiles. tidycensus uses the Census cartographic boundary shapefiles for faster processing; if you prefer the TIGER/Line shapefiles, set cb = FALSE in the function call."

## Exporting spatial data

We can save data "shapefile" or "GeoJSON" files for use in external GIS or visualization applications using `st_write` (sf package). Use in ArcGIS, QGIS, Tableau, or any other application that reads shapefiles.
```{r writing spatial data example}
tarr_output_file <- "test_sf_files/tarr.shp"
if (!file.exists(tarr_output_file)) {
    st_write(tarr, tarr_output_file)
}
```



## Health data

There is some health-related data in the ACS data (e.g. how many people purchased health insurance), but digging into that seems like a distraction for now.  (In the SF1 dataset, there are no variables where 'concept' column contains 'health') 

```{r health-related variables acs 5}
acs5_2017_vars %>% 
    filter(grepl("health",concept,ignore.case = TRUE)) %>% 
    select(concept) %>% 
    unique() %>% 
    kable(caption="Health-related variables from 2017 acs5 dataset") %>% 
    kable_styling(font_size = 9)
```

